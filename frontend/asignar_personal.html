<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 20px;
            background-color: #f4f5f7;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #0056b3;
            text-align: center;
        }

        h2 {
            color: #555;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
            margin-top: 30px;
        }

        .loader {
            text-align: center;
            padding: 50px;
        }

        .rol-group {
            margin-bottom: 20px;
        }

        .rol-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .rol-group select {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border-radius: 4px;
            border: 1px solid #ccc;
            margin-bottom: 5px;
        }

        .button-group {
            margin-top: 30px;
            display: flex;
            justify-content: space-between;
        }

        button {
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            color: white;
        }

        .btn-save {
            background-color: #28a745;
        }

        .btn-save:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .btn-back {
            background-color: #6c757d;
        }

        .btn-work-order {
            background-color: #17a2b8;
        }

        /* Celeste/cian */
        .btn-work-order:hover {
            background-color: #138496;
        }

        option:disabled {
            color: #ccc;
            background-color: #f4f4f4;
        }

        #notification-banner {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translate(-50%, 150%);
            padding: 12px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            color: white;
            font-size: 16px;
            font-weight: 500;
            z-index: 1000;
            transition: transform 0.5s ease-in-out;
            max-width: 90%;
            text-align: center;
        }

        #notification-banner.show {
            transform: translate(-50%, 0);
        }

        #notification-banner.success {
            background-color: #28a745;
        }

        #notification-banner.error {
            background-color: #dc3545;
        }

        #notification-banner.info {
            background-color: #007bff;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Asignación de Personal</h1>
        <h2 id="solicitud-title"></h2>
        <div id="assignment-form-container">
            <div class="loader" id="loader">Cargando...</div>
        </div>
        <div class="button-group">
            <button class="btn-back" onclick="window.location.href='/admin_solicitudes.html'">Volver al Panel</button>
            <button id="save-button" class="btn-save">Guardar Asignaciones</button>
        </div>
    </div>
    <div id="notification-banner"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- SECCIÓN 1: INICIALIZACIÓN Y ENLACE DE ELEMENTOS ---
            // Obtenemos los IDs de la URL. Son la base para todas nuestras peticiones.
            const params = new URLSearchParams(window.location.search);
            const solicitudId = params.get('solicitudId');
            const tipoEventoId = params.get('tipoEventoId');
            // Enlazamos los elementos del DOM que vamos a manipular.
            const formContainer = document.getElementById('assignment-form-container');
            const loader = document.getElementById('loader');
            const saveButton = document.getElementById('save-button');
            const notificationBanner = document.getElementById('notification-banner');
            const solicitudTitle = document.getElementById('solicitud-title');
            let notificationTimer;
            // Si falta algún ID, mostramos un error y detenemos todo.
            if (!solicitudId || !tipoEventoId) {
                loader.style.display = 'none';
                formContainer.innerHTML =
                    '<p style="color:red; font-weight:bold;">Error: Faltan el ID de solicitud o el ID de tipo de evento en la URL.</p>';
                return;
            }
            solicitudTitle.textContent = `Para Solicitud ID: ${solicitudId} (Tipo: ${tipoEventoId})`;
            // --- SECCIÓN 2: LÓGICA DE CARGA DE DATOS ---
            async function cargarDatosDeAsignacion() {
                try {
                    // Hacemos la llamada a nuestra nueva API para obtener todos los datos necesarios.
                    const response = await fetch(
                        `/api/admin/asignacion-data?solicitudId=${solicitudId}&tipoEventoId=${tipoEventoId}`
                        );
                    if (response.status === 401) {
                        window.location.href = '/login.html';
                        return;
                    }
                    if (!response.ok) throw new Error('No se pudieron cargar los datos del servidor.');
                    const data = await response.json();
                    console.log("Datos de asignación recibidos:", data);
                    loader.style.display = 'none';
                    if (!data.rolesRequeridos || data.rolesRequeridos.length === 0) {
                        formContainer.innerHTML =
                            '<p>Este tipo de evento no tiene roles de personal requeridos.</p>';
                        saveButton.disabled = true;
                        return;
                    }
                    renderizarFormulario(data.rolesRequeridos, data.personalDisponible, data
                        .asignacionesGuardadas);
                } catch (error) {
                    console.error("Error al cargar datos de asignación:", error);
                    loader.style.display = 'none';
                    formContainer.innerHTML =
                    `<p style="color:red; font-weight:bold;">${error.message}</p>`;
                }
            }
            // --- SECCIÓN 3: LÓGICA DE RENDERIZADO Y UI ---
            function renderizarFormulario(rolesRequeridos, personalPorRol, asignacionesGuardadas) {
                let formHtml = '';
                let asignacionesRestantes = [...(asignacionesGuardadas || [])];
                
                // Si ya hay asignaciones guardadas, cambiamos el botón a "Ver orden de trabajo"
                if (asignacionesGuardadas && asignacionesGuardadas.length > 0) {
                    saveButton.textContent = 'Ver orden de trabajo';
                    saveButton.className = 'btn-work-order';
                    saveButton.onclick = () => {
                        window.location.href = `/orden_de_trabajo.html?solicitudId=${solicitudId}`;
                    };
                } else {
                    saveButton.textContent = 'Guardar Asignaciones';
                    saveButton.className = 'btn-save';
                    saveButton.onclick = null;
                    saveButton.addEventListener('click', guardarAsignaciones);
                }
                
                rolesRequeridos.forEach(rol => {
                    formHtml +=
                        `<div class="rol-group"><label>${rol.rol} (requeridos: ${rol.cantidad})</label>`;
                    for (let i = 0; i < rol.cantidad; i++) {
                        const personalParaEsteRol = personalPorRol[rol.rol] || [];
                        let valorSeleccionado = '';
                        const indiceAsignacion = asignacionesRestantes.findIndex(asig => asig.rol ===
                            rol.rol);
                        if (indiceAsignacion > -1) {
                            valorSeleccionado = asignacionesRestantes[indiceAsignacion].personalId;
                            asignacionesRestantes.splice(indiceAsignacion, 1);
                        }
                        // Creamos las opciones del select
                        let opcionesHtml = '<option value="">-- Seleccionar --</option>';
                        personalParaEsteRol.forEach(persona => {
                            const esSeleccionado = persona.id === valorSeleccionado ?
                                'selected' : '';
                            opcionesHtml +=
                                `<option value="${persona.id}" ${esSeleccionado}>${persona.nombre}</option>`;
                        });
                        formHtml += `<select name="${rol.rol}">${opcionesHtml}</select>`;
                    }
                    formHtml += `</div>`;
                });
                formContainer.innerHTML = formHtml;
                // Añadimos el listener una vez que el HTML está en el DOM
                formContainer.addEventListener('change', deshabilitarOpcionesSeleccionadas);
                // Ejecutamos una vez al principio para deshabilitar las opciones ya cargadas
                deshabilitarOpcionesSeleccionadas();
            }

            function deshabilitarOpcionesSeleccionadas() {
                const allSelects = Array.from(formContainer.querySelectorAll('select'));
                const selectedIds = new Set();
                // Primero, encontramos todos los IDs que están actualmente seleccionados
                allSelects.forEach(select => {
                    if (select.value) selectedIds.add(select.value);
                });
                // Luego, recorremos todos los selects de nuevo para deshabilitar opciones
                allSelects.forEach(select => {
                    const currentSelection = select.value;
                    select.querySelectorAll('option').forEach(option => {
                        if (option.value) { // Ignoramos la opción vacía
                            // Deshabilitamos una opción si su ID está en el set de seleccionados,
                            // PERO no es la selección actual de ESTE select.
                            option.disabled = selectedIds.has(option.value) && option.value !==
                                currentSelection;
                        }
                    });
                });
            }

            function showNotification(message, type = 'info', duration = 4000) {
                clearTimeout(notificationTimer);
                notificationBanner.textContent = message;
                notificationBanner.className = 'show ' + type;
                notificationTimer = setTimeout(() => {
                    notificationBanner.className = '';
                }, duration);
            }
            // --- SECCIÓN 4: LÓGICA DE GUARDADO ---
            async function guardarAsignaciones() {
                console.log("Guardando asignaciones...");
                console.log("formContainer contenido:", formContainer.innerHTML);
                saveButton.disabled = true;
                saveButton.textContent = 'Guardando...';
                
                // Recolectar todas las selecciones de los selects
                const selectsElements = Array.from(formContainer.querySelectorAll('select'));
                console.log("Total de selects encontrados:", selectsElements.length);
                console.log("Selects encontrados:", selectsElements.map(s => ({ name: s.name, value: s.value })));
                
                // Validar que todos los selects tengan un valor seleccionado
                const selectsSinValor = selectsElements.filter(select => !select.value);
                if (selectsSinValor.length > 0) {
                    showNotification('Por favor selecciona personal para todos los roles requeridos.', 'error');
                    saveButton.disabled = false;
                    saveButton.textContent = 'Guardar Asignaciones';
                    return;
                }
                
                // Construir el array de asignaciones
                const assignments = [];
                selectsElements.forEach(select => {
                    // NO hacer parseInt - el ID de personal es VARCHAR (string)
                    const personalId = select.value;
                    console.log(`Procesando select: name=${select.name}, value=${select.value}, personalId=${personalId}`);
                    if (personalId && personalId.trim() !== '') {
                        assignments.push({
                            rol: select.name,
                            personalId: personalId
                        });
                        console.log(`Asignación agregada: rol=${select.name}, personalId=${personalId}`);
                    } else {
                        console.log(`Asignación NO agregada: personalId vacío`);
                    }
                });
                
                console.log("Total de asignaciones a guardar:", assignments.length);
                console.log("Array de asignaciones:", JSON.stringify(assignments));
                
                try {
                    const response = await fetch(`/api/admin/solicitudes/${solicitudId}/asignaciones`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(assignments)
                    });
                    console.log("Respuesta del servidor:", response.status);
                    const data = await response.json();
                    console.log("Datos recibidos:", data);
                    if (!response.ok) throw new Error(data.message || 'Error del servidor.');
                    showNotification(data.message, 'success');
                    console.log("Guardado exitoso. Redirigiendo en 1 segundo...");
                    // Redirigir a orden de trabajo después de un pequeño delay
                    setTimeout(() => {
                        window.location.href = `/orden_de_trabajo.html?solicitudId=${solicitudId}`;
                    }, 1000);
                } catch (error) {
                    console.error("Error:", error);
                    showNotification(error.message, 'error');
                    saveButton.disabled = false;
                    saveButton.textContent = 'Guardar Asignaciones';
                }
            }
            // --- SECCIÓN 5: PUNTO DE ENTRADA ---
            saveButton.addEventListener('click', guardarAsignaciones);
            // La ejecución comienza aquí
            cargarDatosDeAsignacion();
        });
    </script>
</body>

</html>
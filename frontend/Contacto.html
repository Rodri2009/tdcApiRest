<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* ... Tus estilos se mantienen exactamente igual ... */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f4f4f4;
      color: #333;
      padding-bottom: 70px;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      background-color: #fff;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    h2 {
      color: #0056b3;
      text-align: center;
      margin-bottom: 5px;
    }

    h3.subtitle {
      color: #0056b3;
      text-align: center;
      margin-top: 0;
      margin-bottom: 25px;
      font-size: 1.1em;
      font-weight: normal;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #555;
    }

    .form-group {
      margin-bottom: 15px;
    }

    input[type="text"],
    input[type="email"],
    input[type="tel"] {
      width: 100%;
      padding: 10px;
      border: 1.5px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .campo-invalido {
      border-color: #e74c3c !important;
      animation: shake 0.5s;
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0);
      }

      20%,
      60% {
        transform: translateX(-5px);
      }

      40%,
      80% {
        transform: translateX(5px);
      }
    }

    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }

    button {
      flex: 1;
      background-color: #28a745;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }

    button:hover {
      background-color: #218838;
    }

    button.btn-secondary {
      background-color: #6c757d;
    }

    button.btn-secondary:hover {
      background-color: #5a6268;
    }

    button.secondary {
      background-color: #6c757d;
    }

    button.secondary:hover {
      background-color: #5a6268;
    }

    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
      border-radius: 8px;
      flex-direction: column;
    }

    .loading-overlay p {
      font-size: 1.2em;
      font-weight: bold;
      color: #0056b3;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin-top: 10px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    #notification-banner {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translate(-50%, 150%);
      padding: 12px 25px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      color: white;
      font-size: 16px;
      font-weight: 500;
      z-index: 1000;
      transition: transform 0.5s ease-in-out;
      max-width: 90%;
      text-align: center;
    }

    #notification-banner.show {
      transform: translate(-50%, 0);
    }

    #notification-banner.success {
      background-color: #28a745;
    }

    #notification-banner.error {
      background-color: #dc3545;
    }

    #notification-banner.warning {
      background-color: #ffc107;
      color: #333;
    }

    textarea {
      width: 100%;
      padding: 10px;
      border: 1.5px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 16px;
      font-family: Arial, sans-serif;
      /* Asegura la misma fuente que los inputs */
      transition: border-color 0.3s;
      resize: vertical;
      /* Permite al usuario ajustar la altura */
    }
  </style>
</head>

<body>
  <div id="notification-banner"></div>
  <div class="container">
    <h2>Paso Final: Tus Datos de Contacto</h2>
    <div id="resumen-solicitud">
      <p>Cargando resumen...</p>
    </div>

    <div class="form-group">
      <label for="nombreCompleto">Nombre y Apellido:</label>
      <input type="text" id="nombreCompleto" name="nombreCompleto" required>
    </div>
    <div class="form-group">
      <label for="celular">Celular (con código de área):</label>
      <input type="text" id="celular" name="celular" required>
    </div>
    <div class="form-group">
      <label for="email">Email:</label>
      <input type="email" id="email" name="email" required>
    </div>
    <div class="form-group">
      <label for="detallesAdicionales">¿Algo más que debamos saber? (Opcional)</label>
      <textarea id="detallesAdicionales" name="detallesAdicionales" rows="4"></textarea>
    </div>
    <div class="button-group">
      <button id="btn-volver" class="secondary">Volver</button>
      <button id="btn-confirmar">Confirmar y Enviar Solicitud</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {

      function resetearCamposInvalidos() {
        const camposInvalidos = document.querySelectorAll('.campo-invalido');
        camposInvalidos.forEach(campo => {
            campo.classList.remove('campo-invalido');
            campo.style.animation = 'none';
            void campo.offsetWidth;
            campo.style.animation = '';
        });
      }

      const notificationBanner = document.getElementById('notification-banner'); // <-- Enlazar banner
      let notificationTimer = null; // <-- Añadir variable para el timer

      function convertirNumero(numero) {
        const num = typeof numero === 'number' ? numero.toString().trim() : numero.trim();
        if (num === '') return '';
        // Detectar formato y convertir a número
        const esAmericano = /^-?\d{1,3}(,\d{3})*(\.\d+)?$/.test(num);
        const esArgentino = /^-?\d{1,3}(\.\d{3})*(,\d+)?$/.test(num);
        if (esArgentino) return num;
        let numeroLimpio = num.replace(/[^\d.,-]/g, '');
        numeroLimpio = esAmericano ? num.replace(/,/g, '') : numeroLimpio.replace('.', ',');
        // Convertir a número y formatear con separadores de miles
        const partes = numeroLimpio.split(',');
        let parteEntera = partes[0].replace(/\D/g, '');
        const parteDecimal = partes[1] || '00';
        // Agregar puntos de miles
        parteEntera = parteEntera.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        return parteDecimal ? `${parteEntera},${parteDecimal}` : parteEntera;
      }

      // 1. Obtener el ID de la solicitud desde la URL
      const params = new URLSearchParams(window.location.search);
      const solicitudId = params.get('solicitudId');
      const fromPage = params.get('from'); // <-- Leemos el nuevo parámetro
      const btnVolver = document.getElementById('btn-volver');
      const resumenDiv = document.getElementById('resumen-solicitud');

      if (!solicitudId) {
        resumenDiv.innerHTML = '<p style="color: red;">Error: No se encontró un ID de solicitud.</p>';
        return;
      }

      // 2. Llamar a la API para obtener los detalles de la solicitud
      fetch(`/api/solicitudes/${solicitudId}`)
        .then(response => {
          if (!response.ok) throw new Error('No se pudo cargar la solicitud.');
          showNotification("Datos cargados","success");
          return response.json();
        })
        .then(data => {
          let totalAdicionales = 0;
          let listaAdicionales = "";
          if (data.adicionales && data.adicionales.length > 0) {
            data.adicionales.forEach(ad => {
              totalAdicionales += parseFloat(ad.adicional_precio);
              listaAdicionales = listaAdicionales == "" ? ad.adicional_nombre : listaAdicionales + ", " + ad.adicional_nombre
              //listaAdicionales += ad.adicional_nombre + " ";
            });
          }
          console.log("total adicionales",totalAdicionales);

          // 3. Mostrar los datos en la página
          const fecha = new Date(data.fecha_evento).toLocaleDateString('es-AR', { timeZone: 'UTC' });
          resumenDiv.innerHTML = `
                    <h3>Resumen de tu evento:</h3>
                    <ul>
                      <li><strong>Tipo:</strong> ${data.nombre_para_mostrar || data.tipo_de_evento}</li>
                      <li><strong>Fecha:</strong> ${fecha}  <strong>Hora:</strong> ${data.hora_evento}</li>
                      <li><strong>Adicionales:</strong> ${listaAdicionales}</li>
                      <li><strong>TOTAL:</strong> $${convertirNumero(parseFloat(data.precio_basico) + parseFloat(totalAdicionales))}</li>
                  </ul>
                `;
        })
        .catch(error => {
          console.error('Error:', error);
          resumenDiv.innerHTML = `<p style="color: red;">${error.message}</p>`;
        });

      // Lógica para el nuevo botón de volver
      btnVolver.onclick = () => {
        if (fromPage === 'adicionales') {
          window.location.href = `/Adicionales.html?solicitudId=${solicitudId}`;
        } else {
          // Si venimos de 'page' o de ningún lado, volvemos a Page.html
          window.location.href = `/Page.html?solicitudId=${solicitudId}`;
        }
      };

      document.getElementById('btn-confirmar').onclick = () => {

        resetearCamposInvalidos();

        const solicitudId = params.get('solicitudId');
        let hayErrores = false;

        // 1. Recolectar datos del formulario de contacto
        const bodyData = {
          nombreCompleto: document.getElementById('nombreCompleto').value,
          celular: document.getElementById('celular').value,
          email: document.getElementById('email').value,
          detallesAdicionales: document.getElementById('detallesAdicionales').value,
        };

        if (!bodyData.nombreCompleto) { document.getElementById('nombreCompleto').classList.add('campo-invalido'); hayErrores = true; }
        if (!bodyData.celular) { document.getElementById('celular').classList.add('campo-invalido'); hayErrores = true; }
        if (!bodyData.email) { document.getElementById('email').classList.add('campo-invalido'); hayErrores = true; }

        if (hayErrores) {
            showNotification('Por favor, completa todos los campos obligatorios.', 'warning');
            return;
        }


        // 2. Realizar la llamada a la API con el método PUT
        fetch(`/api/solicitudes/${solicitudId}/finalizar`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(bodyData)
        })
          .then(response => {
            if (!response.ok) throw new Error('Error al confirmar la solicitud.');
            return response.json();
          })
          .then(data => {
            console.log('Respuesta del servidor:', data.message);
            // 3. Redirigir a la página de comprobante
            window.location.href = `/Comprobante.html?solicitudId=${solicitudId}`;
          })
          .catch(error => {
            console.error('Error:', error);
            showNotification("Error: "+error);
          });
      };

      function showNotification(message, type = 'error', duration = 4000) {
        clearTimeout(notificationTimer);
        notificationBanner.textContent = message;
        notificationBanner.className = 'show ' + type;
        notificationTimer = setTimeout(() => { notificationBanner.className = ''; }, duration);
      }

    });
  </script>
</body>

</html>
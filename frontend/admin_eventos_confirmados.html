<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin - Eventos Confirmados</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: Inter, sans-serif;
            background: #0c0a09;
            color: #d6d3d1;
            padding: calc(16px + 4rem) 16px 16px 16px;
        }

        .table-container {
            max-width: 1400px;
            margin: 0 auto;
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid rgba(240, 171, 252, 0.08);
            overflow-x: auto
        }

        th,
        td {
            padding: 10px 12px;
            text-align: left;
            font-size: 14px;
            border-bottom: 1px solid #222
        }

        th {
            background: linear-gradient(135deg, #581c87, #764ba2);
            color: #f0abfc;
            text-transform: uppercase;
            font-weight: 700
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            flex-wrap: wrap
        }

        .description {
            white-space: pre-wrap;
            overflow-wrap: anywhere;
            word-break: break-word;
            max-width: 360px
        }

        /* Flyer thumbnail */
        .flyer-thumb {
            width: 90px;
            height: 56px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.04);
        }

        .btn {
            background: #764ba2;
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer
        }

        #loader {
            text-align: center;
            padding: 24px;
            color: #9f7aea
        }
    </style>
</head>

<body>
    <header class="bg-rustic"
        style="position:fixed;top:0;left:0;right:0;z-index:999;padding:12px;background:#121212;border-bottom:1px solid rgba(255,255,255,0.03)">
        <div style="max-width:1200px;margin:0 auto;color:#f0abfc;font-weight:700">Panel Admin — Eventos Confirmados
        </div>
    </header>

    <main style="max-width:1200px;margin:100px auto 40px auto">
        <div class="table-container">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                <h2 style="color:#f0abfc;margin:0">Eventos Confirmados</h2>
                <div>
                    <button id="refreshBtn" class="btn">Actualizar</button>
                </div>
            </div>

            <div class="filters" aria-hidden="false">
                <select id="tipoFilter">
                    <option value="">-- Tipo de evento (todos) --</option>
                    <option value="ALQUILER">ALQUILER</option>
                    <option value="BANDA">BANDA</option>
                    <option value="TALLER">TALLER</option>
                    <option value="SERVICIO">SERVICIO</option>
                </select>
                <input type="date" id="desde" />
                <input type="date" id="hasta" />
                <label style="display:inline-flex;align-items:center;gap:6px">Hora desde <input type="time"
                        id="hora_desde" /></label>
                <label style="display:inline-flex;align-items:center;gap:6px">Hora hasta <input type="time"
                        id="hora_hasta" /></label>
                <label style="display:inline-flex;align-items:center;gap:6px">Ordenar
                    <select id="order_by">
                        <option value="fecha_evento">Fecha</option>
                        <option value="hora_inicio">Hora</option>
                        <option value="nombre_evento">Nombre</option>
                    </select>
                    <select id="order_dir">
                        <option value="DESC">Desc</option>
                        <option value="ASC">Asc</option>
                    </select>
                </label>
                <input type="number" id="limit" placeholder="Por página" style="width:110px" value="20" />
                <button id="filtrarBtn" class="btn">Filtrar</button>
            </div>

            <div id="loader" style="display:none">Cargando...</div>

            <div id="tabla" style="overflow-x:auto">
                <table id="eventsTable">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Hora</th>
                            <th>Tipo</th>
                            <th>Cliente</th>
                            <th>Nombre</th>
                            <th>Flyer</th>
                            <th>Detalles</th>
                            <th>Descripción</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div style="display:flex;align-items:center;gap:10px;margin-top:12px">
                <button id="prevPage" class="btn">Anterior</button>
                <span id="pageInfo">Página 1</span>
                <button id="nextPage" class="btn">Siguiente</button>
            </div>

            <div id="empty" style="display:none;padding:20px;text-align:center;color:#9f7aea">No se encontraron eventos
                con esos filtros.</div>
        </div>
    </main>

    <script src="/navbar.js"></script>
    <script>
        function getToken() { return localStorage.getItem('authToken') }
        function getHeaders() { return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${getToken()}` } }

        const $loader = document.getElementById('loader');
        const $tbody = document.querySelector('#eventsTable tbody');
        const $empty = document.getElementById('empty');

        async function fetchEventos() {
            $loader.style.display = 'block';
            $tbody.innerHTML = '';
            $empty.style.display = 'none';

            const tipo = document.getElementById('tipoFilter').value;
            const desde = document.getElementById('desde').value;
            const hasta = document.getElementById('hasta').value;
            const limit = document.getElementById('limit').value || 200;

            const params = new URLSearchParams();
            if (tipo) params.set('tipo_evento', tipo);
            if (desde) params.set('fecha_desde', desde);
            if (hasta) params.set('fecha_hasta', hasta);
            const horaDesde = document.getElementById('hora_desde').value;
            const horaHasta = document.getElementById('hora_hasta').value;
            if (horaDesde) params.set('hora_desde', horaDesde);
            if (horaHasta) params.set('hora_hasta', horaHasta);
            const orderBy = document.getElementById('order_by').value;
            const orderDir = document.getElementById('order_dir').value;
            params.set('order_by', orderBy);
            params.set('order_dir', orderDir);
            params.set('limit', limit);
            params.set('offset', currentPage * (parseInt(limit, 10) || 20));

            try {
                updatePageInfo();
                const res = await fetch(`/api/admin/eventos_confirmados?${params.toString()}`, { headers: getHeaders() });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const rows = await res.json();
                if (!rows || rows.length === 0) {
                    $empty.style.display = 'block';
                    return;
                }
                function renderDetails(item) {
                    if (item.tipo_evento && item.tipo_evento.toUpperCase().includes('BANDA')) {
                        return item.genero_musical ? `Género: ${item.genero_musical}` : '';
                    }
                    if (item.cantidad_personas) return `Capacidad: ${item.cantidad_personas}`;
                    if (item.tipo_servicio) return `Servicio: ${item.tipo_servicio}`;
                    if (item.nombre_taller) return `Taller: ${item.nombre_taller}`;
                    return '';
                }

                async function cancelEventoClient(id) {
                    if (!confirm('¿Cancelar este evento?')) return;
                    try {
                        const res = await fetch(`/api/admin/eventos_confirmados/${id}/cancel`, { method: 'PATCH', headers: getHeaders() });
                        if (!res.ok) throw new Error('Error al cancelar');
                        fetchEventos();
                    } catch (err) {
                        console.error('Error cancelando evento', err);
                        alert('No se pudo cancelar el evento. Revisa la consola.');
                    }
                }

                for (const r of rows) {
                    const tr = document.createElement('tr');
                    const detalles = renderDetails(r);
                    const estadoBadge = r.activo === 0 ? `<span class="estado-cancelado" style="background:#f87171;color:#fff;padding:4px 6px;border-radius:6px;font-weight:700">CANCELADO</span>` : '';
                    tr.innerHTML = `
            <td>${r.fecha_evento || ''}</td>
            <td>${r.hora_inicio || ''}</td>
            <td>${r.tipo_evento || ''}</td>
            <td>${r.nombre_cliente || ''}</td>
            <td>${r.nombre_evento || ''} ${estadoBadge}</td>
            <td>${r.url_flyer ? '<img src="'+r.url_flyer+'" class="flyer-thumb" alt="flyer">' : ''}</td>
            <td>${detalles}</td>
            <td class="description">${r.descripcion_corta || ''}</td>
            <td class="actions-cell">
              <a class="btn" href="/editar_solicitud?id=${r.id_solicitud}">Ver solicitud</a>
              <a class="btn" href="/editar_evento?id=${r.id}" style="background:#4caf50; margin-left:6px">Editar</a>
              <a class="btn" href="/asignar_personal.html?solicitudId=ev_${r.id}&tipoEventoId=${r.tipo_evento}" style="background:#4f46e5;margin-left:6px">Asignar Personal</a>
              <button class="btn btn-cancel" style="background:#f97316;margin-left:6px" onclick="cancelEventoClient(${r.id})">Cancelar</button>
              <button class="btn btn-delete" style="background:#f43f5e;margin-left:6px" onclick="deleteEvento(${r.id})">Eliminar</button>
            </td>
          `;
                    $tbody.appendChild(tr);
                }
            } catch (err) {
                console.error('Error fetching eventos confirmados', err);
                alert('Error al obtener eventos confirmados. Revisa la consola.');
            } finally {
                $loader.style.display = 'none';
            }
        }

        // Pagination and controls
        let currentPage = 0;
        const pageInfo = document.getElementById('pageInfo');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');

        function updatePageInfo() {
            pageInfo.textContent = `Página ${currentPage + 1}`;
        }

        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 0) { currentPage -= 1; fetchEventos(); }
        });
        nextPageBtn.addEventListener('click', () => { currentPage += 1; fetchEventos(); });

        document.getElementById('filtrarBtn').addEventListener('click', () => { currentPage = 0; fetchEventos(); });
        document.getElementById('refreshBtn').addEventListener('click', fetchEventos);

        // Auto load
        fetchEventos();
    </script>
</body>

</html>
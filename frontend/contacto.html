<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contacto y Confirmación</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* ------------------------------------- */
    /* DEFINICIÓN DE VARIABLES Y ESTILOS BASE */
    /* ------------------------------------- */
    :root {
      --color-primary: #581c87;
      /* Morado oscuro de Talleres */
      --color-secondary: #f0abfc;
      /* Neon/Fucsia de Talleres */
      --color-rustic: #44403c;
      /* Gris/Marrón de Talleres */
      --color-bg-dark: #0c0a09;
      /* Fondo principal */
      --color-card-dark: #1e293b;
      /* Fondo de la tarjeta/contenedor */
      --color-text-light: #d6d3d1;
    }

    /* Estilos generales */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0 0 70px 0;
      /* Ajuste para el sticky navbar */
      background-color: var(--color-bg-dark);
      color: var(--color-text-light);
    }

    .container {
      max-width: 500px;
      margin: 20px auto;
      /* Ajuste de margen superior */
      background-color: var(--color-card-dark);
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      border: 1px solid var(--color-rustic);
      position: relative;
    }

    h2 {
      text-align: center;
      margin-bottom: 5px;
      font-size: 2.25rem !important;
      font-weight: bold;
      color: var(--color-secondary);
      /* Color Neon */
      text-shadow: 0 0 5px var(--color-secondary), 0 0 10px var(--color-secondary);
    }

    h3.subtitle {
      color: var(--color-secondary);
      text-align: center;
      margin-top: 0;
      margin-bottom: 25px;
      font-size: 1.2em;
      font-weight: normal;
    }

    label {
      display: block;
      /*margin-bottom: 8px;*/
      font-weight: bold;
      color: var(--color-text-light);
    }

    .form-group {
      margin-top: 15px;
      margin-bottom: 15px;
    }

    #resumen {
      padding: 15px;
      border: 1px solid var(--color-secondary);
      border-radius: 5px;
      background-color: #0f172a;
    }

    #resumen p,
    #resumen ul li {
      color: #f8fafc;
      /* Texto en resumen */
    }


    input[type="text"],
    input[type="tel"],
    input[type="email"],
    textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--color-primary);
      background-color: #0f172a;
      /* Input Dark */
      color: var(--color-text-light);
      border-radius: 6px;
      box-sizing: border-box;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    input[type="text"]:focus,
    input[type="tel"]:focus,
    input[type="email"]:focus,
    textarea:focus {
      border-color: var(--color-secondary);
      outline: none;
      box-shadow: 0 0 5px var(--color-secondary);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    .campo-invalido {
      border-color: #ef4444 !important;
      box-shadow: 0 0 5px #ef4444 !important;
    }

    /* ------------------------------------- */
    /* NAVEGACIÓN SUPERIOR (COPIADA) */
    /* ------------------------------------- */
    #top-nav {
      background-color: var(--color-card-dark);
      border-bottom: 2px solid var(--color-primary);
      padding: 15px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    #top-nav .logo {
      font-size: 1.5rem;
      font-weight: bold;
    }

    #top-nav .nav-links {
      display: flex;
      gap: 20px;
    }

    #top-nav .nav-item {
      color: #d6d3d1;
      text-decoration: none;
      font-weight: 500;
      padding: 5px 10px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    #top-nav .nav-item:hover {
      color: var(--color-secondary);
      background-color: rgba(240, 171, 252, 0.1);
    }

    /* La página actual es Contacto */
    #top-nav .active-nav {
      color: var(--color-secondary);
      text-shadow: 0 0 5px rgba(240, 171, 252, 0.5);
      border-bottom: 2px solid var(--color-secondary);
    }

    .text-neon {
      color: var(--color-secondary);
      text-shadow: 0 0 5px var(--color-secondary), 0 0 10px var(--color-secondary);
    }


    /* ------------------------------------- */
    /* BOTONES */
    /* ------------------------------------- */
    .button-group {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 30px;
    }

    .button-group button {
      background-color: transparent;
      color: var(--color-secondary);
      border: 2px solid var(--color-secondary);
      padding: 15px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      transition: all 0.3s ease-in-out;
      text-decoration: none;
      box-sizing: border-box;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      width: 100%;
    }

    .button-group button:hover {
      background-color: rgba(132, 63, 172, 0.2);
      transform: scale(1.02);
      color: var(--color-secondary);
      border-color: var(--color-secondary);
    }

    .button-group button:disabled {
      background-color: #6b7280;
      color: #d1d5db;
      border-color: #6b7280;
      cursor: not-allowed;
      transform: scale(1.0);
    }

    /* ------------------------------------- */
    /* NOTIFICACIONES */
    /* ------------------------------------- */
    #notification-banner {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translate(-50%, 150%);
      padding: 12px 25px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      color: white;
      font-size: 16px;
      font-weight: 500;
      z-index: 1000;
      transition: transform 0.5s ease-in-out;
      max-width: 90%;
      text-align: center;
    }

    #notification-banner.show {
      transform: translate(-50%, 0);
    }

    #notification-banner.error {
      background-color: #ef4444;
    }

    #notification-banner.warning {
      background-color: #f59e0b;
    }
  </style>
</head>

<body>

  <nav id="top-nav">
    <div class="logo">
      <a href="index.html" class="flex items-center space-x-3">
        <img src="./img/logo_transparente.png" alt="El Templo de Claypole Logo" class="h-10 w-auto">
        <span class="text-2xl font-bold text-neon tracking-wider hidden sm:block">Volver al Inicio</span>
      </a>
    </div>
    <div class="nav-links">
      <a href="#" onclick="redirigir('presupuesto')" class="nav-item">Presupuesto</a>
      <a href="#" onclick="redirigir('adicionales')" class="nav-item">Adicionales</a>
      <a href="/contacto.html" class="nav-item active-nav">Contacto</a>
    </div>
  </nav>

  <div id="notification-banner"></div>
  <div class="container">
    <h2>Paso Final: Tus Datos de Contacto</h2>
    <div id="resumen">
      <p>Cargando resumen...</p>
    </div>

    <div class="form-group">
      <label for="nombreCompleto">Nombre y Apellido:</label>
      <input type="text" id="nombreCompleto" name="nombreCompleto" required>
    </div>
    <div class="form-group">
      <label for="celular">Celular (con código de área):</label>
      <input type="text" id="celular" name="celular" required>
    </div>
    <div class="form-group">
      <label for="email">Email:</label>
      <input type="email" id="email" name="email" required>
    </div>
    <div class="form-group">
      <label for="detallesAdicionales">¿Algo más que debamos saber? (Opcional)</label>
      <textarea id="detallesAdicionales" name="detallesAdicionales" rows="4"></textarea>
    </div>
    <div class="button-group">
      <button id="btn-volver" class="secondary">Volver</button>
      <button id="btn-confirmar">Confirmar y Enviar Solicitud</button>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const solicitudId = params.get('solicitudId');

    document.addEventListener('DOMContentLoaded', () => {

      function resetearCamposInvalidos() {
        const camposInvalidos = document.querySelectorAll('.campo-invalido');
        camposInvalidos.forEach(campo => {
          campo.classList.remove('campo-invalido');
          campo.style.animation = 'none';
          void campo.offsetWidth;
          campo.style.animation = '';
        });
      }

      const notificationBanner = document.getElementById('notification-banner'); // <-- Enlazar banner
      let notificationTimer = null; // <-- Añadir variable para el timer

      function convertirNumero(numero) {
        const num = typeof numero === 'number' ? numero.toString().trim() : numero.trim();
        if (num === '') return '';
        // Detectar formato y convertir a número
        const esAmericano = /^-?\d{1,3}(,\d{3})*(\.\d+)?$/.test(num);
        const esArgentino = /^-?\d{1,3}(\.\d{3})*(,\d+)?$/.test(num);
        if (esArgentino) return num;
        let numeroLimpio = num.replace(/[^\d.,-]/g, '');
        numeroLimpio = esAmericano ? num.replace(/,/g, '') : numeroLimpio.replace('.', ',');
        // Convertir a número y formatear con separadores de miles
        const partes = numeroLimpio.split(',');
        let parteEntera = partes[0].replace(/\D/g, '');
        const parteDecimal = partes[1] || '00';
        // Agregar puntos de miles
        parteEntera = parteEntera.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        return parteDecimal ? `${parteEntera},${parteDecimal}` : parteEntera;
      }

      // 1. Obtener el ID de la solicitud desde la URL
      //const params = new URLSearchParams(window.location.search);
      //const solicitudId = params.get('solicitudId');

      const fromPage = params.get('from'); // <-- Leemos el nuevo parámetro
      const btnVolver = document.getElementById('btn-volver');
      const resumenDiv = document.getElementById('resumen');

      if (!solicitudId) {
        resumenDiv.innerHTML = '<p style="color: red;">Error: No se encontró un ID de solicitud.</p>';
        return;
      }

      // 2. Llamar a la API para obtener los detalles de la solicitud
      fetch(`/api/solicitudes/${solicitudId}`)
        .then(response => {
          if (!response.ok) throw new Error('No se pudo cargar la solicitud.');
          showNotification("Datos cargados", "success");
          return response.json();
        })
        .then(data => {
          //console.log(data);
          let totalAdicionales = 0;
          let listaAdicionales = "";
          if (data.adicionales && data.adicionales.length > 0) {
            data.adicionales.forEach(ad => {
              totalAdicionales += parseFloat(ad.precio);
              listaAdicionales = listaAdicionales == "" ? ad.nombre : listaAdicionales + ", " + ad.nombre
              //listaAdicionales += ad.adicional_nombre + " ";
            });
          }
          //console.log("total adicionales",totalAdicionales);

          // 3. Mostrar los datos en la página
          const fecha = new Date(data.fechaEvento).toLocaleDateString('es-AR', { timeZone: 'UTC' });
          resumenDiv.innerHTML = `
                    <h3>Resumen:</h3>
                    <ul>
                      <li><strong>Tipo:</strong> ${data.nombreParaMostrar || data.tipoEvento}</li>
                      <li><strong>Fecha:</strong> ${fecha}</li>
                      <li><strong>Hora:</strong> ${data.horaInicio}</li>
                      <li><strong>Adicionales:</strong> ${listaAdicionales}</li>
                      <li><strong>TOTAL:</strong> $${convertirNumero(parseFloat(data.precioBase) + parseFloat(totalAdicionales))}</li>
                  </ul>
                `;
        })
        .catch(error => {
          console.error('Error:', error);
          resumenDiv.innerHTML = `<p style="color: red;">${error.message}</p>`;
        });

      // Lógica para el nuevo botón de volver
      btnVolver.onclick = () => {
        if (fromPage === 'adicionales') {
          window.location.href = `/adicionales.html?solicitudId=${solicitudId}`;
        } else {
          // Si venimos de 'page' o de ningún lado, volvemos a page.html
          window.location.href = `/page.html?solicitudId=${solicitudId}`;
        }
      };

      document.getElementById('btn-confirmar').onclick = () => {

        resetearCamposInvalidos();

        const solicitudId = params.get('solicitudId');
        let hayErrores = false;

        // 1. Recolectar datos del formulario de contacto
        const bodyData = {
          nombreCompleto: document.getElementById('nombreCompleto').value,
          celular: document.getElementById('celular').value,
          email: document.getElementById('email').value,
          detallesAdicionales: document.getElementById('detallesAdicionales').value,
        };

        if (!bodyData.nombreCompleto) { document.getElementById('nombreCompleto').classList.add('campo-invalido'); hayErrores = true; }
        if (!bodyData.celular) { document.getElementById('celular').classList.add('campo-invalido'); hayErrores = true; }
        if (!bodyData.email) { document.getElementById('email').classList.add('campo-invalido'); hayErrores = true; }

        if (hayErrores) {
          showNotification('Por favor, completa todos los campos obligatorios.', 'warning');
          return;
        }


        // 2. Realizar la llamada a la API con el método PUT
        fetch(`/api/solicitudes/${solicitudId}/finalizar`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(bodyData)
        })
          .then(response => {
            if (!response.ok) throw new Error('Error al confirmar la solicitud.');
            return response.json();
          })
          .then(data => {
            console.log('Respuesta del servidor:', data.message);
            // 3. Redirigir a la página de comprobante
            window.location.href = `/comprobante.html?solicitudId=${solicitudId}`;
          })
          .catch(error => {
            console.error('Error:', error);
            showNotification("Error: " + error);
          });
      };

      function showNotification(message, type = 'error', duration = 4000) {
        clearTimeout(notificationTimer);
        notificationBanner.textContent = message;
        notificationBanner.className = 'show ' + type;
        notificationTimer = setTimeout(() => { notificationBanner.className = ''; }, duration);
      }

    });


    function redirigir(fromPage) {
      if (fromPage === 'adicionales') {
        window.location.href = `/adicionales.html?solicitudId=${solicitudId}`;
      } else {
        window.location.href = `/page.html?solicitudId=${solicitudId}`;
      }
    }
  </script>
</body>

</html>
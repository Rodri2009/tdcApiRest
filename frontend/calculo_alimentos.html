<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cálculo de Alimentos</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 15px;
        }
        
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
        }
        
        .app-description {
            background-color: #e8f4fc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            border-left: 4px solid #3498db;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background-color: #e9ecef;
        }
        
        .tab.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 0 0 5px 5px;
            background-color: #fff;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-section {
            margin-bottom: 25px;
        }
        
        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 15px;
            gap: 15px;
        }
        
        .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .deductions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .deduction-group {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        
        .deduction-group label {
            color: #495057;
            font-size: 0.9em;
        }
        
        .btn {
            padding: 12px 24px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-calculate {
            background-color: #2ecc71;
            display: block;
            margin: 20px auto;
            padding: 15px 30px;
            font-size: 18px;
        }
        
        .btn-calculate:hover {
            background-color: #27ae60;
        }
        
        .btn-secondary {
            background-color: #95a5a6;
        }
        
        .btn-secondary:hover {
            background-color: #7f8c8d;
        }
        
        .results {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            border-left: 4px solid #2ecc71;
        }
        
        .results h3 {
            color: #2ecc71;
            margin-bottom: 15px;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .result-label {
            font-weight: 600;
        }
        
        .result-value {
            font-weight: 700;
            color: #2c3e50;
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .history-table th, .history-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        
        .history-table th {
            background-color: #3498db;
            color: white;
        }
        
        .history-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .history-table tr:hover {
            background-color: #f1f1f1;
        }
        
        .edit-btn, .delete-btn {
            padding: 5px 10px;
            margin: 0 3px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .edit-btn {
            background-color: #f39c12;
            color: white;
        }
        
        .delete-btn {
            background-color: #e74c3c;
            color: white;
        }
        
        .actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        
        .export-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            border-left: 4px solid #9b59b6;
        }
        
        .export-section h3 {
            color: #9b59b6;
            margin-bottom: 15px;
        }
        
        .message {
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            display: none;
        }
        
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        .month-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .fixed-costs {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .form-group {
                min-width: 100%;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1;
                min-width: 120px;
                text-align: center;
                margin-bottom: 5px;
            }
            
            .deductions-grid, .fixed-costs {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Cálculo de Pensión Alimenticia</h1>
        <p class="subtitle">Sistema para calcular el porcentaje de alimentos basado en ingresos brutos y deducciones</p>
        
        <div class="app-description">
            <p>Esta aplicación permite calcular el monto de pensión alimenticia basado en ingresos brutos, deducciones y porcentajes aplicables. Puede guardar el historial de cálculos y exportar los datos.</p>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="new-calculation">Nuevo Cálculo</div>
            <div class="tab" data-tab="history">Historial</div>
            <div class="tab" data-tab="settings">Configuración</div>
        </div>
        
        <!-- Nuevo Cálculo Tab -->
        <div id="new-calculation" class="tab-content active">
            <div class="form-section">
                <h3>Datos del Mes</h3>
                <div class="month-selector">
                    <div class="form-group">
                        <label for="month">Mes:</label>
                        <select id="month">
                            <option value="Enero">Enero</option>
                            <option value="Febrero">Febrero</option>
                            <option value="Marzo">Marzo</option>
                            <option value="Abril">Abril</option>
                            <option value="Mayo">Mayo</option>
                            <option value="Junio">Junio</option>
                            <option value="Julio">Julio</option>
                            <option value="Agosto">Agosto</option>
                            <option value="Septiembre">Septiembre</option>
                            <option value="Octubre">Octubre</option>
                            <option value="Noviembre">Noviembre</option>
                            <option value="Diciembre">Diciembre</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="year">Año:</label>
                        <input type="number" id="year" min="2020" max="2030" value="2025">
                    </div>
                    <div class="form-group">
                        <label for="type">Tipo:</label>
                        <select id="type">
                            <option value="normal">Mes Normal</option>
                            <option value="aguinaldo">Aguinaldo</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="bruto">Ingreso Bruto:</label>
                        <input type="number" id="bruto" step="0.01" placeholder="Ej: 134969.30">
                    </div>
                    <div class="form-group">
                        <label for="percentage">Porcentaje a aplicar (%):</label>
                        <input type="number" id="percentage" step="0.01" value="20" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label for="additional-percentage">Reducción adicional (%):</label>
                        <input type="number" id="additional-percentage" step="0.01" value="0" min="0" max="100">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Deducciones</h3>
                
                <div class="deductions-grid">
                    <div class="deduction-group">
                        <label for="deduction1">Deducción 1:</label>
                        <input type="number" id="deduction1" step="0.01" value="14846.62">
                    </div>
                    
                    <div class="deduction-group">
                        <label for="deduction2">Deducción 2:</label>
                        <input type="number" id="deduction2" step="0.01" value="4049.08">
                    </div>
                    
                    <div class="deduction-group">
                        <label for="deduction3">Deducción 3:</label>
                        <input type="number" id="deduction3" step="0.01" value="4049.08">
                    </div>
                    
                    <div class="deduction-group">
                        <label for="deduction4">Deducción 4:</label>
                        <input type="number" id="deduction4" step="0.01" value="0">
                    </div>
                    
                    <div class="deduction-group">
                        <label for="deduction5">Deducción 5:</label>
                        <input type="number" id="deduction5" step="0.01" value="0">
                    </div>
                    
                    <div class="deduction-group">
                        <label for="deduction6">Deducción 6:</label>
                        <input type="number" id="deduction6" step="0.01" value="0">
                    </div>
                </div>
                
                <h4 style="margin-top: 20px; margin-bottom: 15px;">Costos Fijos</h4>
                
                <div class="fixed-costs">
                    <div class="deduction-group">
                        <label for="fixed1">Fijo 1:</label>
                        <input type="number" id="fixed1" step="0.01" value="3.80" readonly>
                    </div>
                    
                    <div class="deduction-group">
                        <label for="fixed2">Fijo 2:</label>
                        <input type="number" id="fixed2" step="0.01" value="180.00" readonly>
                    </div>
                </div>
            </div>
            
            <button id="calculate-btn" class="btn btn-calculate">Calcular Pensión Alimenticia</button>
            
            <div id="results-container" class="results" style="display: none;">
                <h3>Resultados del Cálculo</h3>
                <div class="result-item">
                    <span class="result-label">Ingreso Bruto:</span>
                    <span id="result-bruto" class="result-value">0.00</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Total Deducciones:</span>
                    <span id="result-total-deductions" class="result-value">0.00</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Base para cálculo:</span>
                    <span id="result-base" class="result-value">0.00</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Porcentaje aplicado:</span>
                    <span id="result-percentage" class="result-value">0%</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Monto antes de reducción:</span>
                    <span id="result-before-reduction" class="result-value">0.00</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Reducción adicional:</span>
                    <span id="result-reduction" class="result-value">0%</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Monto Final de Pensión:</span>
                    <span id="result-final" class="result-value" style="color: #e74c3c; font-size: 1.2em;">0.00</span>
                </div>
                
                <div class="actions">
                    <button id="save-calculation" class="btn">Guardar Cálculo</button>
                    <button id="clear-form" class="btn btn-secondary">Nuevo Cálculo</button>
                </div>
            </div>
            
            <div id="message" class="message"></div>
        </div>
        
        <!-- Historial Tab -->
        <div id="history" class="tab-content">
            <h3>Historial de Cálculos</h3>
            <p>Aquí puedes ver, editar o eliminar cálculos anteriores.</p>
            
            <div id="history-table-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Bruto</th>
                            <th>Deducciones</th>
                            <th>% Aplicado</th>
                            <th>Reducción</th>
                            <th>Resultado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body">
                        <!-- Los datos se cargarán dinámicamente -->
                    </tbody>
                </table>
            </div>
            
            <div class="export-section">
                <h3>Exportar Datos</h3>
                <p>Exporta todos los cálculos a un archivo de texto para guardar un respaldo.</p>
                <button id="export-btn" class="btn">Exportar a Archivo de Texto</button>
                <button id="import-btn" class="btn btn-secondary">Importar desde Archivo</button>
                <input type="file" id="import-file" accept=".txt" style="display: none;">
            </div>
        </div>
        
        <!-- Configuración Tab -->
        <div id="settings" class="tab-content">
            <h3>Configuración de la Aplicación</h3>
            
            <div class="form-section">
                <h3>Valores Predeterminados</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="default-percentage">Porcentaje predeterminado (%):</label>
                        <input type="number" id="default-percentage" step="0.01" value="20" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label for="default-fixed1">Valor fijo 1:</label>
                        <input type="number" id="default-fixed1" step="0.01" value="3.80">
                    </div>
                    <div class="form-group">
                        <label for="default-fixed2">Valor fijo 2:</label>
                        <input type="number" id="default-fixed2" step="0.01" value="180.00">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Manejo de Datos</h3>
                <div class="form-row">
                    <div class="form-group">
                        <button id="clear-all-data" class="btn" style="background-color: #e74c3c;">Borrar Todos los Datos</button>
                        <p style="margin-top: 10px; font-size: 0.9em; color: #7f8c8d;">Esta acción eliminará todo el historial y no se puede deshacer.</p>
                    </div>
                </div>
            </div>
            
            <div id="settings-message" class="message"></div>
        </div>
    </div>

    <script>
        // Datos de ejemplo basados en el documento
        const sampleCalculations = [
            { 
                id: 1, 
                month: "Enero", 
                year: "2023", 
                type: "normal", 
                bruto: 712418.19, 
                deductions: [60351.71, 16459.56, 16459.56, 0, 0, 0, 3.80, 180.00, 113944.55], 
                percentage: 20, 
                additionalPercentage: 0, 
                result: 71003.80 
            },
            { 
                id: 2, 
                month: "Febrero", 
                year: "2023", 
                type: "normal", 
                bruto: 828908.43, 
                deductions: [77323.23, 21088.15, 21088.15, 0, 0, 0, 3.80, 180.00, 98199.50], 
                percentage: 20, 
                additionalPercentage: 0, 
                result: 78205.12 
            },
            { 
                id: 3, 
                month: "Marzo", 
                year: "2023", 
                type: "normal", 
                bruto: 700219.52, 
                deductions: [60351.71, 16459.56, 16459.56, 0, 0, 0, 3.80, 180.00, 113332.44], 
                percentage: 20, 
                additionalPercentage: 0, 
                result: 71686.49 
            },
            { 
                id: 4, 
                month: "Junio", 
                year: "2024", 
                type: "normal", 
                bruto: 2231318.33, 
                deductions: [161877.77, 44148.48, 44148.48, 0, 0, 0, 3.80, 180.00, 52096.00], 
                percentage: 20, 
                additionalPercentage: 35, 
                result: 257524.77 
            }
        ];

        // Variables globales
        let calculations = [];
        let currentCalculationId = null;

        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM completamente cargado");
            
            // Cargar datos guardados o usar datos de ejemplo
            loadCalculations();
            
            // Configurar pestañas
            setupTabs();
            
            // Configurar botones y eventos
            setupEventListeners();
            
            // Mostrar historial inicial
            renderHistoryTable();
            
            console.log("Aplicación inicializada correctamente");
        });

        // Configurar pestañas
        function setupTabs() {
            console.log("Configurando pestañas...");
            
            const tabs = document.querySelectorAll('.tab');
            console.log(`Encontradas ${tabs.length} pestañas:`, tabs);
            
            const tabContents = document.querySelectorAll('.tab-content');
            console.log(`Encontrados ${tabContents.length} contenidos de pestaña:`, tabContents);
            
            tabs.forEach(tab => {
                console.log(`Configurando evento para pestaña: ${tab.textContent}`);
                
                tab.addEventListener('click', function() {
                    console.log(`Clic en pestaña: ${this.textContent}`);
                    console.log(`data-tab attribute: ${this.getAttribute('data-tab')}`);
                    
                    const tabId = this.getAttribute('data-tab');
                    console.log(`ID de pestaña a mostrar: ${tabId}`);
                    
                    // Remover clase active de todas las pestañas y contenidos
                    tabs.forEach(t => {
                        console.log(`Removiendo clase active de pestaña: ${t.textContent}`);
                        t.classList.remove('active');
                    });
                    
                    tabContents.forEach(c => {
                        console.log(`Removiendo clase active de contenido: ${c.id}`);
                        c.classList.remove('active');
                    });
                    
                    // Agregar clase active a la pestaña seleccionada
                    console.log(`Agregando clase active a pestaña: ${this.textContent}`);
                    this.classList.add('active');
                    
                    // Encontrar y activar el contenido correspondiente
                    const targetContent = document.getElementById(tabId);
                    if (targetContent) {
                        console.log(`Encontrado contenido con ID ${tabId}, agregando clase active`);
                        targetContent.classList.add('active');
                    } else {
                        console.error(`No se encontró contenido con ID: ${tabId}`);
                    }
                });
            });
            
            console.log("Pestañas configuradas correctamente");
        }

        // Configurar eventos
        function setupEventListeners() {
            console.log("Configurando event listeners...");
            
            // Botón de calcular
            const calculateBtn = document.getElementById('calculate-btn');
            if (calculateBtn) {
                calculateBtn.addEventListener('click', calculatePension);
                console.log("Event listener agregado a botón calcular");
            } else {
                console.error("No se encontró el botón calcular");
            }
            
            // Botón para guardar cálculo
            const saveBtn = document.getElementById('save-calculation');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveCalculation);
                console.log("Event listener agregado a botón guardar cálculo");
            }
            
            // Botón para limpiar formulario
            const clearBtn = document.getElementById('clear-form');
            if (clearBtn) {
                clearBtn.addEventListener('click', clearForm);
                console.log("Event listener agregado a botón limpiar formulario");
            }
            
            // Botón para exportar datos
            const exportBtn = document.getElementById('export-btn');
            if (exportBtn) {
                exportBtn.addEventListener('click', exportData);
                console.log("Event listener agregado a botón exportar");
            }
            
            // Botón para importar datos
            const importBtn = document.getElementById('import-btn');
            if (importBtn) {
                importBtn.addEventListener('click', () => {
                    console.log("Clic en botón importar, abriendo selector de archivos");
                    document.getElementById('import-file').click();
                });
                console.log("Event listener agregado a botón importar");
            }
            
            // Evento para importar archivo
            const importFile = document.getElementById('import-file');
            if (importFile) {
                importFile.addEventListener('change', importData);
                console.log("Event listener agregado a input de importar archivo");
            }
            
            // Botón para borrar todos los datos
            const clearAllBtn = document.getElementById('clear-all-data');
            if (clearAllBtn) {
                clearAllBtn.addEventListener('click', clearAllData);
                console.log("Event listener agregado a botón borrar todos los datos");
            }
            
            // Guardar configuración cuando cambian los valores
            const defaultPercentage = document.getElementById('default-percentage');
            if (defaultPercentage) {
                defaultPercentage.addEventListener('change', saveSettings);
            }
            
            const defaultFixed1 = document.getElementById('default-fixed1');
            if (defaultFixed1) {
                defaultFixed1.addEventListener('change', saveSettings);
            }
            
            const defaultFixed2 = document.getElementById('default-fixed2');
            if (defaultFixed2) {
                defaultFixed2.addEventListener('change', saveSettings);
            }
            
            // Cargar configuración
            loadSettings();
            
            console.log("Todos los event listeners configurados");
        }

        // Calcular pensión alimenticia
        function calculatePension() {
            console.log("Calculando pensión alimenticia...");
            
            // Obtener valores del formulario
            const bruto = parseFloat(document.getElementById('bruto').value) || 0;
            const percentage = parseFloat(document.getElementById('percentage').value) || 20;
            const additionalPercentage = parseFloat(document.getElementById('additional-percentage').value) || 0;
            
            console.log(`Bruto: ${bruto}, Porcentaje: ${percentage}%, Reducción adicional: ${additionalPercentage}%`);
            
            // Obtener todas las deducciones (6 deducciones + 2 fijos)
            const deduction1 = parseFloat(document.getElementById('deduction1').value) || 0;
            const deduction2 = parseFloat(document.getElementById('deduction2').value) || 0;
            const deduction3 = parseFloat(document.getElementById('deduction3').value) || 0;
            const deduction4 = parseFloat(document.getElementById('deduction4').value) || 0;
            const deduction5 = parseFloat(document.getElementById('deduction5').value) || 0;
            const deduction6 = parseFloat(document.getElementById('deduction6').value) || 0;
            const fixed1 = parseFloat(document.getElementById('fixed1').value) || 0;
            const fixed2 = parseFloat(document.getElementById('fixed2').value) || 0;
            
            console.log(`Deducciones: ${deduction1}, ${deduction2}, ${deduction3}, ${deduction4}, ${deduction5}, ${deduction6}, ${fixed1}, ${fixed2}`);
            
            // Validar entrada
            if (bruto <= 0) {
                showMessage('Por favor ingresa un valor válido para el ingreso bruto.', 'error');
                console.error("Error: Bruto es menor o igual a 0");
                return;
            }
            
            // Calcular total de deducciones (todas las deducciones + fijos)
            const totalDeductions = deduction1 + deduction2 + deduction3 + 
                                   deduction4 + deduction5 + deduction6 + 
                                   fixed1 + fixed2;
            console.log(`Total deducciones: ${totalDeductions}`);
            
            // Calcular base para el cálculo
            const base = bruto - totalDeductions;
            console.log(`Base para cálculo: ${base}`);
            
            // Calcular porcentaje sobre la base
            const percentageAmount = base * (percentage / 100);
            console.log(`Monto del porcentaje: ${percentageAmount}`);
            
            // Aplicar reducción adicional si existe
            let finalAmount = percentageAmount;
            let reductionAmount = 0;
            
            if (additionalPercentage > 0) {
                reductionAmount = percentageAmount * (additionalPercentage / 100);
                finalAmount = percentageAmount - reductionAmount;
                console.log(`Reducción adicional: ${reductionAmount}, Monto final: ${finalAmount}`);
            }
            
            // Mostrar resultados
            document.getElementById('result-bruto').textContent = formatCurrency(bruto);
            document.getElementById('result-total-deductions').textContent = formatCurrency(totalDeductions);
            document.getElementById('result-base').textContent = formatCurrency(base);
            document.getElementById('result-percentage').textContent = `${percentage}%`;
            document.getElementById('result-before-reduction').textContent = formatCurrency(percentageAmount);
            document.getElementById('result-reduction').textContent = additionalPercentage > 0 ? `${additionalPercentage}% (${formatCurrency(reductionAmount)})` : '0%';
            document.getElementById('result-final').textContent = formatCurrency(finalAmount);
            
            // Mostrar contenedor de resultados
            document.getElementById('results-container').style.display = 'block';
            
            // Guardar cálculo temporal
            currentCalculationId = Date.now(); // ID temporal
            console.log(`Cálculo completado. ID temporal: ${currentCalculationId}`);
        }

        // Guardar cálculo en el historial
        function saveCalculation() {
            console.log("Guardando cálculo...");
            
            // Obtener valores del formulario
            const month = document.getElementById('month').value;
            const year = document.getElementById('year').value;
            const type = document.getElementById('type').value;
            const bruto = parseFloat(document.getElementById('bruto').value) || 0;
            const percentage = parseFloat(document.getElementById('percentage').value) || 20;
            const additionalPercentage = parseFloat(document.getElementById('additional-percentage').value) || 0;
            
            console.log(`Datos a guardar: ${month} ${year}, Bruto: ${bruto}, %: ${percentage}, Reducción: ${additionalPercentage}`);
            
            // Obtener todas las deducciones
            const deduction1 = parseFloat(document.getElementById('deduction1').value) || 0;
            const deduction2 = parseFloat(document.getElementById('deduction2').value) || 0;
            const deduction3 = parseFloat(document.getElementById('deduction3').value) || 0;
            const deduction4 = parseFloat(document.getElementById('deduction4').value) || 0;
            const deduction5 = parseFloat(document.getElementById('deduction5').value) || 0;
            const deduction6 = parseFloat(document.getElementById('deduction6').value) || 0;
            const fixed1 = parseFloat(document.getElementById('fixed1').value) || 0;
            const fixed2 = parseFloat(document.getElementById('fixed2').value) || 0;
            
            // Crear array con todas las deducciones (6 deducciones + 2 fijos)
            const deductions = [deduction1, deduction2, deduction3, deduction4, 
                               deduction5, deduction6, fixed1, fixed2];
            
            // Obtener resultado final
            const resultText = document.getElementById('result-final').textContent;
            const result = parseFloat(resultText.replace(/[^0-9.-]+/g, "")) || 0;
            
            console.log(`Resultado a guardar: ${result}`);
            
            // Crear objeto de cálculo
            const calculation = {
                id: currentCalculationId || Date.now(),
                month,
                year,
                type,
                bruto,
                deductions: [...deductions],
                percentage,
                additionalPercentage,
                result,
                date: new Date().toISOString()
            };
            
            console.log("Objeto cálculo creado:", calculation);
            
            // Verificar si es una actualización o un nuevo cálculo
            const existingIndex = calculations.findIndex(c => c.id === calculation.id);
            console.log(`Índice existente: ${existingIndex}`);
            
            if (existingIndex >= 0) {
                // Actualizar cálculo existente
                calculations[existingIndex] = calculation;
                console.log(`Cálculo actualizado con ID: ${calculation.id}`);
                showMessage('Cálculo actualizado correctamente.', 'success');
            } else {
                // Agregar nuevo cálculo
                calculations.push(calculation);
                console.log(`Nuevo cálculo agregado con ID: ${calculation.id}`);
                showMessage('Cálculo guardado correctamente.', 'success');
            }
            
            // Guardar en localStorage
            saveCalculations();
            
            // Actualizar tabla de historial
            renderHistoryTable();
            
            // Limpiar formulario después de guardar
            clearForm();
        }

        // Limpiar formulario
        function clearForm() {
            console.log("Limpiando formulario...");
            
            // Limpiar campos principales
            document.getElementById('bruto').value = '';
            document.getElementById('percentage').value = document.getElementById('default-percentage').value || '20';
            document.getElementById('additional-percentage').value = '0';
            
            // Limpiar deducciones (dejar solo los valores predeterminados en los primeros 3)
            document.getElementById('deduction1').value = '14846.62';
            document.getElementById('deduction2').value = '4049.08';
            document.getElementById('deduction3').value = '4049.08';
            document.getElementById('deduction4').value = '0';
            document.getElementById('deduction5').value = '0';
            document.getElementById('deduction6').value = '0';
            
            // Los campos fijos se mantienen
            document.getElementById('fixed1').value = document.getElementById('default-fixed1').value || '3.80';
            document.getElementById('fixed2').value = document.getElementById('default-fixed2').value || '180.00';
            
            // Ocultar resultados
            document.getElementById('results-container').style.display = 'none';
            
            // Restablecer ID
            currentCalculationId = null;
            
            showMessage('Formulario limpiado. Puedes ingresar nuevos datos.', 'success');
            console.log("Formulario limpiado");
        }

        // Mostrar mensajes
        function showMessage(text, type) {
            console.log(`Mostrando mensaje: ${text} (tipo: ${type})`);
            
            const messageElement = document.getElementById('message');
            if (!messageElement) {
                console.error("No se encontró el elemento para mensajes");
                return;
            }
            
            messageElement.textContent = text;
            messageElement.className = `message ${type}`;
            messageElement.style.display = 'block';
            
            // Ocultar mensaje después de 5 segundos
            setTimeout(() => {
                messageElement.style.display = 'none';
                console.log("Mensaje ocultado");
            }, 5000);
        }

        // Formatear moneda
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-AR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        // Renderizar tabla de historial
        function renderHistoryTable() {
            console.log("Renderizando tabla de historial...");
            
            const tableBody = document.getElementById('history-table-body');
            if (!tableBody) {
                console.error("No se encontró el cuerpo de la tabla de historial");
                return;
            }
            
            tableBody.innerHTML = '';
            
            if (calculations.length === 0) {
                console.log("No hay cálculos para mostrar en el historial");
                tableBody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 20px;">No hay cálculos guardados aún.</td></tr>`;
                return;
            }
            
            console.log(`Mostrando ${calculations.length} cálculos en el historial`);
            
            // Ordenar cálculos por fecha (más reciente primero)
            const sortedCalculations = [...calculations].sort((a, b) => {
                // Primero por año, luego por mes
                const monthOrder = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", 
                                  "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                
                if (a.year !== b.year) {
                    return b.year - a.year;
                }
                
                return monthOrder.indexOf(b.month) - monthOrder.indexOf(a.month);
            });
            
            // Agregar cada cálculo a la tabla
            sortedCalculations.forEach(calc => {
                const totalDeductions = calc.deductions.reduce((sum, val) => sum + val, 0);
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${calc.month} ${calc.year} ${calc.type === 'aguinaldo' ? '(Aguinaldo)' : ''}</td>
                    <td>${formatCurrency(calc.bruto)}</td>
                    <td>${formatCurrency(totalDeductions)}</td>
                    <td>${calc.percentage}%</td>
                    <td>${calc.additionalPercentage > 0 ? calc.additionalPercentage + '%' : 'Ninguna'}</td>
                    <td>${formatCurrency(calc.result)}</td>
                    <td>
                        <button class="edit-btn" data-id="${calc.id}">Editar</button>
                        <button class="delete-btn" data-id="${calc.id}">Eliminar</button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Agregar eventos a los botones de editar y eliminar
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    console.log(`Editando cálculo con ID: ${id}`);
                    editCalculation(id);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    console.log(`Eliminando cálculo con ID: ${id}`);
                    deleteCalculation(id);
                });
            });
            
            console.log("Tabla de historial renderizada correctamente");
        }

        // Editar cálculo existente
        function editCalculation(id) {
            console.log(`Editando cálculo ID: ${id}`);
            
            const calculation = calculations.find(c => c.id === id);
            
            if (!calculation) {
                console.error(`No se encontró cálculo con ID: ${id}`);
                showMessage('No se encontró el cálculo a editar.', 'error');
                return;
            }
            
            console.log("Cálculo encontrado:", calculation);
            
            // Cambiar a la pestaña de nuevo cálculo
            const newCalcTab = document.querySelector('[data-tab="new-calculation"]');
            if (newCalcTab) {
                newCalcTab.click();
                console.log("Cambiando a pestaña de nuevo cálculo");
            }
            
            // Llenar formulario con los datos del cálculo
            document.getElementById('month').value = calculation.month;
            document.getElementById('year').value = calculation.year;
            document.getElementById('type').value = calculation.type;
            document.getElementById('bruto').value = calculation.bruto;
            document.getElementById('percentage').value = calculation.percentage;
            document.getElementById('additional-percentage').value = calculation.additionalPercentage;
            
            // Llenar deducciones (6 deducciones + 2 fijos)
            if (calculation.deductions.length >= 8) {
                document.getElementById('deduction1').value = calculation.deductions[0];
                document.getElementById('deduction2').value = calculation.deductions[1];
                document.getElementById('deduction3').value = calculation.deductions[2];
                document.getElementById('deduction4').value = calculation.deductions[3];
                document.getElementById('deduction5').value = calculation.deductions[4];
                document.getElementById('deduction6').value = calculation.deductions[5];
                document.getElementById('fixed1').value = calculation.deductions[6];
                document.getElementById('fixed2').value = calculation.deductions[7];
            } else {
                console.warn(`El cálculo ID ${id} no tiene suficientes deducciones (${calculation.deductions.length})`);
            }
            
            // Calcular automáticamente
            setTimeout(() => {
                calculatePension();
                currentCalculationId = calculation.id;
                console.log(`Cálculo cargado para edición con ID: ${calculation.id}`);
            }, 100);
            
            showMessage('Cálculo cargado para edición.', 'success');
        }

        // Eliminar cálculo
        function deleteCalculation(id) {
            console.log(`Solicitando eliminación de cálculo ID: ${id}`);
            
            if (confirm('¿Estás seguro de que quieres eliminar este cálculo? Esta acción no se puede deshacer.')) {
                calculations = calculations.filter(c => c.id !== id);
                console.log(`Cálculo ID: ${id} eliminado. Quedan ${calculations.length} cálculos.`);
                saveCalculations();
                renderHistoryTable();
                showMessage('Cálculo eliminado correctamente.', 'success');
            } else {
                console.log("Eliminación cancelada por el usuario");
            }
        }

        // Exportar datos a archivo de texto
        function exportData() {
            console.log("Exportando datos...");
            
            if (calculations.length === 0) {
                console.log("No hay datos para exportar");
                showMessage('No hay datos para exportar.', 'error');
                return;
            }
            
            console.log(`Exportando ${calculations.length} cálculos`);
            
            // Crear contenido del archivo
            let content = "CÁLCULOS DE PENSIÓN ALIMENTICIA\n";
            content += "================================\n\n";
            content += "Fecha de exportación: " + new Date().toLocaleString() + "\n";
            content += "Total de cálculos: " + calculations.length + "\n\n";
            
            calculations.forEach((calc, index) => {
                const totalDeductions = calc.deductions.reduce((sum, val) => sum + val, 0);
                const base = calc.bruto - totalDeductions;
                
                content += `CÁLCULO ${index + 1}\n`;
                content += `========================\n`;
                content += `Mes: ${calc.month} ${calc.year} ${calc.type === 'aguinaldo' ? '(Aguinaldo)' : ''}\n`;
                content += `Ingreso Bruto: ${formatCurrency(calc.bruto)}\n`;
                content += `Deducciones:\n`;
                
                // Mostrar cada deducción individualmente
                calc.deductions.forEach((ded, idx) => {
                    let label = "";
                    if (idx < 6) {
                        label = `Deducción ${idx + 1}`;
                    } else if (idx === 6) {
                        label = "Fijo 1";
                    } else if (idx === 7) {
                        label = "Fijo 2";
                    }
                    
                    if (ded > 0) {
                        content += `  ${label}: ${formatCurrency(ded)}\n`;
                    }
                });
                
                content += `Total Deducciones: ${formatCurrency(totalDeductions)}\n`;
                content += `Base para cálculo: ${formatCurrency(base)}\n`;
                content += `Porcentaje aplicado: ${calc.percentage}%\n`;
                content += `Reducción adicional: ${calc.additionalPercentage}%\n`;
                content += `Monto de Pensión: ${formatCurrency(calc.result)}\n`;
                content += `\n`;
            });
            
            // Crear y descargar archivo
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const timestamp = new Date().toISOString().slice(0,10).replace(/-/g, '');
            a.download = `calculos-alimentos-${timestamp}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log("Datos exportados correctamente");
            showMessage('Datos exportados correctamente.', 'success');
        }

        // Importar datos desde archivo
        function importData(event) {
            console.log("Importando datos desde archivo...");
            
            const file = event.target.files[0];
            if (!file) {
                console.log("No se seleccionó ningún archivo");
                return;
            }
            
            console.log(`Archivo seleccionado: ${file.name}, tamaño: ${file.size} bytes`);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    console.log("Contenido del archivo leído");
                    
                    // Aquí iría la lógica para parsear el archivo
                    // Por ahora, solo mostraremos un mensaje
                    showMessage('Función de importación en desarrollo. Para importar datos, use la función de carga automática.', 'success');
                    
                    // Limpiar el input de archivo
                    event.target.value = '';
                    
                } catch (error) {
                    console.error("Error al importar archivo:", error);
                    showMessage('Error al importar el archivo. Verifique el formato.', 'error');
                }
            };
            
            reader.readAsText(file);
        }

        // Cargar cálculos desde localStorage
        function loadCalculations() {
            console.log("Cargando cálculos desde localStorage...");
            
            try {
                const savedCalculations = localStorage.getItem('alimentosCalculations');
                if (savedCalculations) {
                    calculations = JSON.parse(savedCalculations);
                    console.log(`${calculations.length} cálculos cargados desde localStorage`);
                } else {
                    // Usar datos de ejemplo si no hay datos guardados
                    calculations = [...sampleCalculations];
                    console.log("Usando datos de ejemplo, no se encontraron cálculos en localStorage");
                }
            } catch (error) {
                console.error("Error al cargar cálculos desde localStorage:", error);
                calculations = [...sampleCalculations];
                console.log("Usando datos de ejemplo debido a error en localStorage");
            }
        }

        // Guardar cálculos en localStorage
        function saveCalculations() {
            console.log("Guardando cálculos en localStorage...");
            
            try {
                localStorage.setItem('alimentosCalculations', JSON.stringify(calculations));
                console.log(`${calculations.length} cálculos guardados en localStorage`);
            } catch (error) {
                console.error("Error al guardar cálculos en localStorage:", error);
            }
        }

        // Cargar configuración
        function loadSettings() {
            console.log("Cargando configuración...");
            
            try {
                const savedSettings = localStorage.getItem('alimentosSettings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    
                    if (settings.defaultPercentage) {
                        document.getElementById('default-percentage').value = settings.defaultPercentage;
                    }
                    
                    if (settings.defaultFixed1) {
                        document.getElementById('default-fixed1').value = settings.defaultFixed1;
                        document.getElementById('fixed1').value = settings.defaultFixed1;
                    }
                    
                    if (settings.defaultFixed2) {
                        document.getElementById('default-fixed2').value = settings.defaultFixed2;
                        document.getElementById('fixed2').value = settings.defaultFixed2;
                    }
                    
                    console.log("Configuración cargada desde localStorage:", settings);
                } else {
                    console.log("No se encontró configuración guardada, usando valores predeterminados");
                }
            } catch (error) {
                console.error("Error al cargar configuración:", error);
            }
        }

        // Guardar configuración
        function saveSettings() {
            console.log("Guardando configuración...");
            
            const settings = {
                defaultPercentage: document.getElementById('default-percentage').value,
                defaultFixed1: document.getElementById('default-fixed1').value,
                defaultFixed2: document.getElementById('default-fixed2').value
            };
            
            try {
                localStorage.setItem('alimentosSettings', JSON.stringify(settings));
                console.log("Configuración guardada:", settings);
                
                // Actualizar campos fijos en el formulario principal
                document.getElementById('fixed1').value = settings.defaultFixed1;
                document.getElementById('fixed2').value = settings.defaultFixed2;
                
                // Mostrar mensaje de confirmación
                const settingsMessage = document.getElementById('settings-message');
                if (settingsMessage) {
                    settingsMessage.textContent = 'Configuración guardada correctamente.';
                    settingsMessage.className = 'message success';
                    settingsMessage.style.display = 'block';
                    
                    setTimeout(() => {
                        settingsMessage.style.display = 'none';
                    }, 3000);
                }
            } catch (error) {
                console.error("Error al guardar configuración:", error);
            }
        }

        // Borrar todos los datos
        function clearAllData() {
            console.log("Solicitando borrado de todos los datos...");
            
            if (confirm('¿Estás seguro de que quieres borrar TODOS los datos? Esta acción eliminará todo el historial y no se puede deshacer.')) {
                calculations = [];
                localStorage.removeItem('alimentosCalculations');
                renderHistoryTable();
                console.log("Todos los datos han sido borrados");
                showMessage('Todos los datos han sido borrados.', 'success');
            } else {
                console.log("Borrado de datos cancelado por el usuario");
            }
        }
    </script>
</body>
</html>
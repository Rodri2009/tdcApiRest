services:
  nginx:
    build:
      # El contexto ahora es la raíz del proyecto
      context: ..
      dockerfile: docker/Dockerfile.nginx
    ports:
      - "80:80"
    volumes:
      - ../frontend:/usr/share/nginx/html
    depends_on:
      - backend
    #networks:
    #  - tdc_network

  backend:
    build:
      # El contexto también es la raíz del proyecto
      context: ..
      dockerfile: docker/Dockerfile.backend
    depends_on:
      mariadb:
        condition: service_healthy # Espera hasta que el healthcheck de mariadb pase
    environment:
      PORT: ${PORT}
      DB_HOST: ${DB_HOST}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      EMAIL_SERVICE: ${EMAIL_SERVICE}
      EMAIL_USER: ${EMAIL_USER}
      EMAIL_PASS: ${EMAIL_PASS}
      EMAIL_ADMIN: ${EMAIL_ADMIN}
      JWT_SECRET: ${JWT_SECRET}
    ports:
      - "3000:3000"
    #networks:
    #  - tdc_network
    volumes:
      # ¡ESTA ES LA RUTA CORREGIDA Y ROBUSTA!
      # La ruta es relativa al archivo docker-compose.yml.
      # Para apuntar a la carpeta `backend` en la raíz, usamos `../backend`.
      - ../backend:/app
      # Volumen nombrado para node_modules: preserva los paquetes instalados en la imagen/contenedor
      - tdc_backend_node_modules:/app/node_modules

  mariadb:
    image: mariadb:10.6
    command:
      - '--max_allowed_packet=64M'
    healthcheck:
      # El 'test' ahora usa las variables del archivo .env
      #test: [ "CMD", "mariadb-admin", "ping", "-h", "localhost", "-u", "${MARIADB_USER}", "-p${MARIADB_PASSWORD}" ]
      #test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MARIADB_ROOT_PASSWORD}"]
      test: [ "CMD-SHELL", "mysqladmin ping -h localhost -u root -p$$MARIADB_ROOT_PASSWORD" ]
      interval: 10s
      timeout: 5s
      retries: 10 # Aumentamos los reintentos
    ports:
      - "3306:3306"
    # La sección 'environment' es crucial aquí. El healthcheck leerá estas variables.
    environment:
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      MARIADB_DATABASE: ${MARIADB_DATABASE}
      MARIADB_USER: ${MARIADB_USER}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}
    volumes:
      - mariadb_data:/var/lib/mysql
      # Docker entrypoint ejecuta automáticamente scripts .sql en orden alfabético
      # Usando prefijo 0X se asegura el orden correcto de ejecución
      - ../database/01_schema.sql:/docker-entrypoint-initdb.d/01_schema.sql
      - ../database/02_schema_tickets.sql:/docker-entrypoint-initdb.d/02_schema_tickets.sql
      - ../database/03_seed.sql:/docker-entrypoint-initdb.d/03_seed.sql
      - ../database/04_seed_tickets.sql:/docker-entrypoint-initdb.d/04_seed_tickets.sql
      - ../database/05_migration_add_event_prices_and_coupon_scope.sql:/docker-entrypoint-initdb.d/05_migration_add_event_prices_and_coupon_scope.sql
      - ../database/06_create_subtables_eventos.sql:/docker-entrypoint-initdb.d/06_create_subtables_eventos.sql
      - ../database/07_migration_create_subtables.sql:/docker-entrypoint-initdb.d/07_migration_create_subtables.sql
      - ../database/08_migration_add_categoria_opciones_tipos.sql:/docker-entrypoint-initdb.d/08_migration_add_categoria_opciones_tipos.sql
      - ../database/09_migration_bandas_solicitudes.sql:/docker-entrypoint-initdb.d/09_migration_bandas_solicitudes.sql
      - ../database/10_migration_add_precios_bandas.sql:/docker-entrypoint-initdb.d/10_migration_add_precios_bandas.sql
      - ../database/11_migration_bandas_invitadas.sql:/docker-entrypoint-initdb.d/11_migration_bandas_invitadas.sql
      - ../database/12_create_eventos_personal.sql:/docker-entrypoint-initdb.d/12_create_eventos_personal.sql
      - ../database/13_restructure_solicitudes_tipos.sql:/docker-entrypoint-initdb.d/13_restructure_solicitudes_tipos.sql
      - ../database/14_add_estado_to_eventos.sql:/docker-entrypoint-initdb.d/14_add_estado_to_eventos.sql
      - ../database/15_restore_solicitudes_test_data.sql:/docker-entrypoint-initdb.d/15_restore_solicitudes_test_data.sql
      - ../database/16_restore_sensitive.sql:/docker-entrypoint-initdb.d/16_restore_sensitive.sql
      - ../database/17_fix_opciones_tipos_categorias.sql:/docker-entrypoint-initdb.d/17_fix_opciones_tipos_categorias.sql
      - ../data_migration/datos_sensibles_backup.sql:/var/lib/mysql-files/datos_sensibles_backup.sql
      - ../database/seeds:/var/lib/mysql-files

# Definición de redes
#networks:
#  tdc_network:
#    driver: bridge

# Definición de volúmenes persistentes
volumes:
  mariadb_data:
  tdc_backend_node_modules:
